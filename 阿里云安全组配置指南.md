# 🔧 阿里云安全组配置完整指南

## 当前问题
- ✅ 服务器防火墙已开放 8000 端口
- ✅ 后端监听 0.0.0.0:8000
- ✅ 本地访问 127.0.0.1:8000 成功
- ❌ 外部访问 api.medai.medai-zjgsu.cn:8000 失败
- **结论**：阿里云安全组配置有问题

---

## 📋 正确配置阿里云安全组的步骤

### 1️⃣ 登录阿里云控制台

访问：https://ecs.console.aliyun.com/

### 2️⃣ 找到您的ECS实例

1. 点击左侧菜单 **「实例与镜像」** → **「实例」**
2. 找到 IP 为 `api.medai.medai-zjgsu.cn` 的实例
3. 点击实例ID进入详情页

### 3️⃣ 进入安全组配置

**方法一**：
- 在实例详情页，点击 **「安全组」** 标签页
- 点击安全组ID（如 `sg-xxx`）

**方法二**：
- 左侧菜单点击 **「网络与安全」** → **「安全组」**
- 找到该实例使用的安全组

### 4️⃣ 添加入方向规则

1. 点击 **「配置规则」**
2. 点击 **「入方向」** 标签页
3. 点击 **「手动添加」** 或 **「快速添加」**

### 5️⃣ 填写规则（关键！）

#### ⚠️ 必须完全按照以下配置：

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **规则方向** | 入方向 | 必须是入方向！ |
| **授权策略** | 允许 | 必须选择允许 |
| **协议类型** | 自定义 TCP | 或者选择 TCP |
| **端口范围** | `8000/8000` | 或者直接填 `8000` |
| **优先级** | 1 | 数字越小优先级越高 |
| **授权类型** | IPv4地址段访问 | |
| **授权对象** | `0.0.0.0/0` | ⚠️ 允许所有IP访问（测试用）|
| **描述** | 健康助手后端API | 便于识别 |

#### 🔒 生产环境建议（测试成功后）：
- 授权对象改为您的具体IP段，如 `123.45.67.0/24`
- 或者只允许特定IP，如 `123.45.67.89/32`

### 6️⃣ 保存并等待生效

1. 点击 **「保存」** 按钮
2. 等待 **10-30 秒** 让规则生效
3. **刷新页面** 确认规则已添加

---

## 🔍 常见配置错误

### ❌ 错误1：规则方向选错
- **错误**：选择了「出方向」
- **正确**：必须选择「入方向」

### ❌ 错误2：端口范围格式错误
- **错误**：`8000` 或 `8000-8000`
- **正确**：`8000/8000`（阿里云格式）

### ❌ 错误3：授权对象错误
- **错误**：`0.0.0.0`（缺少子网掩码）
- **正确**：`0.0.0.0/0`

### ❌ 错误4：协议类型错误
- **错误**：选择了 UDP 或 ALL
- **正确**：必须选择 TCP

### ❌ 错误5：多个安全组冲突
- 检查实例是否绑定了多个安全组
- 确保所有安全组都没有拒绝规则

---

## ✅ 验证配置是否正确

### 在阿里云控制台检查：

1. 进入安全组 → 配置规则 → 入方向
2. 应该能看到类似这样的规则：

```
规则方向    授权策略    协议类型    端口范围    授权对象        优先级    描述
入方向      允许       TCP        8000/8000   0.0.0.0/0      1        健康助手后端API
```

### 在本地测试：

```powershell
# 等待30秒后测试
curl https://api.medai.medai-zjgsu.cn:8000/
```

**预期结果**：
```json
{"message":"欢迎使用健康档案助手API","version":"1.0.0","docs":"/docs"}
```

---

## 🎯 特殊情况处理

### 情况A：规则已添加但仍无法访问

**可能原因**：
1. 规则未生效，等待1-2分钟
2. 实例绑定了多个安全组，其他安全组有拒绝规则
3. 网络ACL有额外限制（企业版）

**解决方法**：
```bash
# 在服务器上重启 uvicorn
pkill -f uvicorn
cd /home/admin/projects/health_agent/backend
nohup uvicorn app:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
```

### 情况B：担心安全问题

**临时测试方案**（仅测试时使用 0.0.0.0/0）：
1. 测试通过后，修改授权对象为您的IP
2. 获取您的公网IP：访问 https://www.ip.cn/
3. 修改授权对象为 `您的IP/32`

---

## 📸 截图参考位置

如果您不确定配置是否正确，请截图以下内容：

1. **ECS实例详情页** → 安全组标签页 → 显示绑定的安全组
2. **安全组详情** → 配置规则 → 入方向规则列表（确保8000端口在列表中）
3. **具体规则详情**（点击8000端口规则查看完整配置）

---

## 🔗 相关阿里云文档

- [安全组规则配置](https://help.aliyun.com/document_detail/25471.html)
- [安全组应用案例](https://help.aliyun.com/document_detail/25475.html)
- [安全组FAQ](https://help.aliyun.com/document_detail/40570.html)

---

## 💡 快速解决方案（不推荐生产环境）

如果急需测试，可以临时：

### 方案1：使用快速规则
1. 进入安全组配置
2. 点击「快速添加」
3. 选择「自定义TCP」
4. 端口范围填 `8000`
5. 授权对象填 `0.0.0.0/0`
6. 立即生效

### 方案2：暂时关闭安全组（极不推荐）
1. 创建一个新的「全部开放」安全组
2. 将实例加入该安全组
3. 测试通过后恢复原安全组

---

## ⚠️ 重要提示

1. **0.0.0.0/0 意味着全球任何人都可以访问，仅用于测试！**
2. **测试通过后务必修改为具体IP段**
3. **生产环境建议：**
   - 使用HTTPS（443端口）
   - 添加API认证（JWT等）
   - 配置WAF（Web应用防火墙）
   - 定期审查安全组规则

---

## 🎉 配置成功标志

当一切正常后，您应该看到：

1. ✅ 阿里云安全组显示 8000/tcp 入方向允许
2. ✅ 服务器防火墙显示 8000/tcp 开放
3. ✅ 本地 `curl https://api.medai.medai-zjgsu.cn:8000/` 返回 200 OK
4. ✅ 微信开发者工具 API 请求成功
5. ✅ 小程序正常运行

---

**请按照上述步骤仔细检查阿里云安全组配置！** 🚀




