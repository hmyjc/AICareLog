# ğŸ”§ ERR_CONNECTION_RESET é”™è¯¯æ’æŸ¥æŒ‡å—

## ğŸ› å½“å‰é”™è¯¯

```
GET https://api.medai.medai-zjgsu.cn:8000/api/health-profile/user_xxx net::ERR_CONNECTION_RESET
```

**é”™è¯¯å«ä¹‰**ï¼šè¿æ¥è¢«é‡ç½®ï¼Œæ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨ã€‚

---

## ğŸ“‹ æ’æŸ¥æ­¥éª¤ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰

### âœ… æ­¥éª¤ 1: æ£€æŸ¥åç«¯æ˜¯å¦æ­£åœ¨è¿è¡Œ

**åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ**ï¼š

```bash
# æ–¹æ³•1: æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -tlnp | grep 8000

# æ–¹æ³•2: æ£€æŸ¥è¿›ç¨‹
ps aux | grep uvicorn
```

**é¢„æœŸç»“æœ**ï¼šåº”è¯¥çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„è¾“å‡ºï¼š
```
tcp  0  0  0.0.0.0:8000  0.0.0.0:*  LISTEN  12345/python
```

**å¦‚æœæ²¡æœ‰è¾“å‡º**ï¼Œè¯´æ˜åç«¯æ²¡æœ‰è¿è¡Œï¼Œéœ€è¦å¯åŠ¨åç«¯ã€‚

---

### âœ… æ­¥éª¤ 2: æ­£ç¡®å¯åŠ¨åç«¯æœåŠ¡

**åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ**ï¼š

```bash
# è¿›å…¥åç«¯ç›®å½•
cd /path/to/health_agent/backend

# æ–¹å¼1: ä½¿ç”¨ uvicorn å¯åŠ¨ï¼ˆæ¨èï¼‰
uvicorn app:app --host 0.0.0.0 --port 8000

# æ–¹å¼2: ä½¿ç”¨ nohup åå°è¿è¡Œ
nohup uvicorn app:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &

# æ–¹å¼3: ä½¿ç”¨ screenï¼ˆæ¨èç”¨äºé•¿æœŸè¿è¡Œï¼‰
screen -S health-agent
uvicorn app:app --host 0.0.0.0 --port 8000
# æŒ‰ Ctrl+A ç„¶åæŒ‰ D é€€å‡º screen
```

**å…³é”®ç‚¹**ï¼š
- âœ… å¿…é¡»ä½¿ç”¨ `--host 0.0.0.0`ï¼ˆä¸è¦ç”¨ 127.0.0.1ï¼‰
- âœ… ç¡®ä¿ç«¯å£æ˜¯ `8000`

---

### âœ… æ­¥éª¤ 3: æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™

**åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ**ï¼š

```bash
# Ubuntu/Debian ç³»ç»Ÿ
sudo ufw status
sudo ufw allow 8000/tcp

# CentOS/RHEL ç³»ç»Ÿ
sudo firewall-cmd --list-ports
sudo firewall-cmd --zone=public --add-port=8000/tcp --permanent
sudo firewall-cmd --reload

# æŸ¥çœ‹é˜²ç«å¢™è§„åˆ™
sudo iptables -L -n | grep 8000
```

---

### âœ… æ­¥éª¤ 4: æ£€æŸ¥äº‘æœåŠ¡å™¨å®‰å…¨ç»„

**å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€AWSç­‰**ï¼š

1. ç™»å½•äº‘æœåŠ¡å™¨æ§åˆ¶å°
2. æ‰¾åˆ°æ‚¨çš„æœåŠ¡å™¨å®ä¾‹
3. è¿›å…¥"å®‰å…¨ç»„"æˆ–"é˜²ç«å¢™è§„åˆ™"è®¾ç½®
4. æ·»åŠ å…¥ç«™è§„åˆ™ï¼š
   - åè®®ï¼šTCP
   - ç«¯å£ï¼š8000
   - æºåœ°å€ï¼š0.0.0.0/0ï¼ˆæˆ–é™åˆ¶ä¸ºç‰¹å®šIPï¼‰

**é˜¿é‡Œäº‘ç¤ºä¾‹**ï¼š
- è¿›å…¥ ECS å®ä¾‹
- ç‚¹å‡»"å®‰å…¨ç»„é…ç½®"
- ç‚¹å‡»"é…ç½®è§„åˆ™"
- æ·»åŠ è§„åˆ™ï¼š
  ```
  æˆæƒç­–ç•¥: å…è®¸
  ä¼˜å…ˆçº§: 1
  åè®®ç±»å‹: è‡ªå®šä¹‰ TCP
  ç«¯å£èŒƒå›´: 8000/8000
  æˆæƒå¯¹è±¡: 0.0.0.0/0
  ```

---

### âœ… æ­¥éª¤ 5: æµ‹è¯•åç«¯è¿æ¥

**åœ¨æ‚¨çš„æœ¬åœ°ç”µè„‘ä¸Šæµ‹è¯•**ï¼š

```bash
# æ–¹æ³•1: ä½¿ç”¨ curl
curl https://api.medai.medai-zjgsu.cn:8000/

# æ–¹æ³•2: ä½¿ç”¨æµè§ˆå™¨
# åœ¨æµè§ˆå™¨ä¸­è®¿é—®: https://api.medai.medai-zjgsu.cn:8000/docs
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… åº”è¯¥èƒ½çœ‹åˆ° FastAPI çš„æ¬¢è¿é¡µé¢æˆ–æ–‡æ¡£é¡µé¢
- âŒ å¦‚æœè¶…æ—¶æˆ–è¿æ¥è¢«æ‹’ç»ï¼Œè¯´æ˜ç«¯å£æœªå¼€æ”¾

---

### âœ… æ­¥éª¤ 6: æ£€æŸ¥åç«¯æ—¥å¿—

**åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ**ï¼š

```bash
# æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
tail -f server.log

# æˆ–è€…ç›´æ¥æŸ¥çœ‹ uvicorn è¾“å‡º
```

**æŸ¥æ‰¾é”™è¯¯ä¿¡æ¯**ï¼š
- æ˜¯å¦æœ‰ MongoDB è¿æ¥é”™è¯¯ï¼Ÿ
- æ˜¯å¦æœ‰ç«¯å£è¢«å ç”¨çš„æç¤ºï¼Ÿ
- æ˜¯å¦æœ‰å…¶ä»–é”™è¯¯ä¿¡æ¯ï¼Ÿ

---

## ğŸš€ å¿«é€Ÿè§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: å®Œæ•´çš„åç«¯å¯åŠ¨å‘½ä»¤ï¼ˆæ¨èï¼‰

åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºå¯åŠ¨è„šæœ¬ `start_backend.sh`ï¼š

```bash
#!/bin/bash

# è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/health_agent/backend

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼ˆå¦‚æœæœ‰ï¼‰
# source venv/bin/activate

# æ€æ­»æ—§è¿›ç¨‹ï¼ˆå¦‚æœæœ‰ï¼‰
pkill -f "uvicorn app:app"

# å¯åŠ¨åç«¯
nohup uvicorn app:app \
  --host 0.0.0.0 \
  --port 8000 \
  --workers 1 \
  > /var/log/health_agent.log 2>&1 &

echo "åç«¯å·²å¯åŠ¨ï¼Œè¿›ç¨‹ID: $!"
echo "æ—¥å¿—æ–‡ä»¶: /var/log/health_agent.log"
```

ä½¿ç”¨æ–¹æ³•ï¼š
```bash
chmod +x start_backend.sh
./start_backend.sh
```

---

### æ–¹æ¡ˆ B: ä½¿ç”¨ systemd ç®¡ç†ï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰

åˆ›å»ºæœåŠ¡æ–‡ä»¶ `/etc/systemd/system/health-agent.service`ï¼š

```ini
[Unit]
Description=Health Agent Backend
After=network.target

[Service]
Type=simple
User=your-username
WorkingDirectory=/path/to/health_agent/backend
Environment="PATH=/path/to/venv/bin"
ExecStart=/path/to/venv/bin/uvicorn app:app --host 0.0.0.0 --port 8000
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

ä½¿ç”¨æ–¹æ³•ï¼š
```bash
sudo systemctl daemon-reload
sudo systemctl start health-agent
sudo systemctl enable health-agent
sudo systemctl status health-agent
```

---

## ğŸ” éªŒè¯æ¸…å•

æ‰§è¡Œå®Œä¸Šè¿°æ­¥éª¤åï¼Œé€ä¸€éªŒè¯ï¼š

- [ ] åç«¯è¿›ç¨‹æ­£åœ¨è¿è¡Œï¼ˆ`ps aux | grep uvicorn`ï¼‰
- [ ] ç«¯å£ 8000 å·²ç›‘å¬ï¼ˆ`netstat -tlnp | grep 8000`ï¼‰
- [ ] æœåŠ¡å™¨é˜²ç«å¢™å…è®¸ 8000 ç«¯å£
- [ ] äº‘æœåŠ¡å™¨å®‰å…¨ç»„å…è®¸ 8000 ç«¯å£
- [ ] æœ¬åœ°å¯ä»¥è®¿é—® `https://api.medai.medai-zjgsu.cn:8000/docs`
- [ ] å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­å·²å…³é—­åŸŸåæ ¡éªŒ

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: ç«¯å£è¢«å ç”¨æ€ä¹ˆåŠï¼Ÿ

```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
sudo lsof -i :8000

# æ€æ­»è¿›ç¨‹
sudo kill -9 <PID>
```

### Q2: å¦‚ä½•æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Ÿ

```bash
# å¦‚æœä½¿ç”¨ nohup
tail -f server.log

# å¦‚æœä½¿ç”¨ systemd
sudo journalctl -u health-agent -f
```

### Q3: è¿æ¥è¶…æ—¶è€Œä¸æ˜¯é‡ç½®ï¼Ÿ

è¿™å¯èƒ½æ˜¯é˜²ç«å¢™é—®é¢˜ï¼Œé‡ç‚¹æ£€æŸ¥ï¼š
- äº‘æœåŠ¡å™¨å®‰å…¨ç»„é…ç½®
- æœåŠ¡å™¨æœ¬åœ°é˜²ç«å¢™ï¼ˆiptables/ufw/firewalldï¼‰

---

## âœ… æˆåŠŸæ ‡å¿—

å½“ä¸€åˆ‡æ­£å¸¸åï¼Œæ‚¨åº”è¯¥èƒ½ï¼š

1. âœ… åœ¨æµè§ˆå™¨ä¸­è®¿é—® `https://api.medai.medai-zjgsu.cn:8000/docs`
2. âœ… çœ‹åˆ° FastAPI çš„äº¤äº’å¼æ–‡æ¡£é¡µé¢
3. âœ… å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸å†æŠ¥è¿æ¥é”™è¯¯
4. âœ… å¯ä»¥æ­£å¸¸è°ƒç”¨ API

---

## ğŸ’¡ æœ€å¯èƒ½çš„åŸå› ï¼ˆä¼˜å…ˆæ£€æŸ¥ï¼‰

æ ¹æ®ç»éªŒï¼Œæœ€å¸¸è§çš„åŸå› æ˜¯ï¼š

1. **äº‘æœåŠ¡å™¨å®‰å…¨ç»„æœªå¼€æ”¾ 8000 ç«¯å£**ï¼ˆ80%ï¼‰
2. **åç«¯å¯åŠ¨æ—¶æ²¡æœ‰ä½¿ç”¨ `--host 0.0.0.0`**ï¼ˆ15%ï¼‰
3. **æœåŠ¡å™¨é˜²ç«å¢™é˜»æ­¢äº†ç«¯å£**ï¼ˆ5%ï¼‰

---

**å»ºè®®**ï¼šå…ˆæ‰§è¡Œæ­¥éª¤ 1-4ï¼Œè¿™é€šå¸¸å°±èƒ½è§£å†³é—®é¢˜ï¼ğŸ¯




