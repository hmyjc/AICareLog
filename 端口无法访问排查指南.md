# 🔧 服务器端口无法访问 - 完整排查指南

## 🐛 当前问题

- ✅ 后端在服务器上启动成功
- ✅ 云服务器安全组已开放 8000 端口
- ❌ 本地无法访问：`curl http://39.104.28.40:8000/` 失败

---

## 📋 排查步骤（按顺序执行）

### ✅ 步骤 1: 确认后端启动方式

**在服务器上执行以下命令检查**：

```bash
# 查看当前运行的进程
ps aux | grep uvicorn

# 查看端口监听情况（关键！）
netstat -tlnp | grep 8000
# 或者
ss -tlnp | grep 8000
```

**预期结果**：
```
tcp  0  0  0.0.0.0:8000  0.0.0.0:*  LISTEN  12345/python
```

**关键点**：
- ✅ 如果是 `0.0.0.0:8000` → 正确，外部可以访问
- ❌ 如果是 `127.0.0.1:8000` → 错误，只能本地访问

---

### ✅ 步骤 2: 如果发现监听的是 127.0.0.1

**解决方法：使用正确的启动命令**

在服务器上重新启动后端：

```bash
# 方式1: 直接使用 uvicorn 命令（推荐）
cd /path/to/health_agent/backend
uvicorn app:app --host 0.0.0.0 --port 8000

# 方式2: 使用 python -m uvicorn
python -m uvicorn app:app --host 0.0.0.0 --port 8000

# 方式3: 后台运行
nohup uvicorn app:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
```

**重要**：必须使用 `--host 0.0.0.0`，不能省略！

---

### ✅ 步骤 3: 检查服务器防火墙

**在服务器上执行**：

```bash
# Ubuntu/Debian 系统
sudo ufw status
sudo ufw allow 8000/tcp
sudo ufw reload

# CentOS/RHEL 系统
sudo firewall-cmd --list-ports
sudo firewall-cmd --zone=public --add-port=8000/tcp --permanent
sudo firewall-cmd --reload

# 或者直接检查 iptables
sudo iptables -L -n | grep 8000
```

---

### ✅ 步骤 4: 在服务器本地测试

**在服务器上执行**：

```bash
# 测试本地是否可访问
curl http://127.0.0.1:8000/

# 测试外部IP是否可访问（在服务器上）
curl http://39.104.28.40:8000/
```

如果服务器本地可以访问，但外部不行，说明是防火墙或安全组问题。

---

### ✅ 步骤 5: 再次确认云服务器安全组

**检查清单**：

1. ✅ 规则类型：**入方向**
2. ✅ 协议：**TCP**
3. ✅ 端口：**8000**（或 8000/8000）
4. ✅ 授权对象：**0.0.0.0/0**（允许所有IP访问）
5. ✅ 状态：**已启用**

**如果规则正确但还是不行**，尝试：
- 删除旧规则，重新添加
- 重启服务器（有时候需要重启才能生效）

---

### ✅ 步骤 6: 检查后端日志

**在服务器上查看日志**：

```bash
# 如果有日志文件
tail -f server.log

# 或者查看 uvicorn 输出
# 应该能看到类似这样的日志：
# INFO:     Started server process [12345]
# INFO:     Waiting for application startup.
# INFO:     Application startup complete.
# INFO:     Uvicorn running on http://0.0.0.0:8000
```

**关键检查**：确认日志显示的是 `http://0.0.0.0:8000` 而不是 `http://127.0.0.1:8000`

---

## 🚀 推荐的启动脚本

在服务器上创建 `start_backend.sh`：

```bash
#!/bin/bash

# 进入后端目录
cd /path/to/health_agent/backend

# 激活虚拟环境（如果有）
# source venv/bin/activate

# 杀死旧进程（如果有）
pkill -f "uvicorn app:app"

# 启动后端（关键：必须使用 --host 0.0.0.0）
nohup uvicorn app:app \
  --host 0.0.0.0 \
  --port 8000 \
  --workers 1 \
  > /var/log/health_agent.log 2>&1 &

echo "后端已启动"
echo "进程ID: $!"
echo "日志文件: /var/log/health_agent.log"
echo ""
echo "验证命令："
echo "  netstat -tlnp | grep 8000"
echo "  curl http://39.104.28.40:8000/"
```

**使用方法**：
```bash
chmod +x start_backend.sh
./start_backend.sh
```

---

## 🔍 快速诊断命令

**在服务器上一次性执行**：

```bash
echo "=== 检查进程 ==="
ps aux | grep uvicorn | grep -v grep

echo ""
echo "=== 检查端口监听 ==="
netstat -tlnp | grep 8000

echo ""
echo "=== 检查防火墙 ==="
sudo ufw status 2>/dev/null || sudo firewall-cmd --list-ports 2>/dev/null || echo "未找到防火墙配置"

echo ""
echo "=== 测试本地访问 ==="
curl -s http://127.0.0.1:8000/ || echo "本地访问失败"

echo ""
echo "=== 测试外部IP访问 ==="
curl -s http://39.104.28.40:8000/ || echo "外部IP访问失败"
```

---

## 💡 最可能的原因（优先级排序）

### 1. 启动时没有使用 `--host 0.0.0.0`（90%）

**症状**：`netstat` 显示监听 `127.0.0.1:8000`

**解决**：使用正确的启动命令

### 2. 服务器防火墙阻止（5%）

**症状**：监听 `0.0.0.0:8000`，但外部无法访问

**解决**：配置防火墙规则

### 3. 安全组配置错误（3%）

**症状**：安全组显示已开放，但实际未生效

**解决**：删除并重新添加规则

### 4. 其他网络问题（2%）

**症状**：以上都正确，但仍无法访问

**解决**：联系云服务商技术支持

---

## ✅ 验证成功标志

当一切正常后，您应该看到：

1. ✅ `netstat` 显示：`0.0.0.0:8000`
2. ✅ 服务器本地：`curl http://127.0.0.1:8000/` 成功
3. ✅ 服务器外部IP：`curl http://39.104.28.40:8000/` 成功
4. ✅ 本地电脑：`curl http://39.104.28.40:8000/` 成功
5. ✅ 微信开发者工具：API 请求成功

---

## 📞 如果还是不行

请提供以下信息：

1. `netstat -tlnp | grep 8000` 的输出
2. `ps aux | grep uvicorn` 的输出
3. 您是如何启动后端的（具体命令）
4. 云服务商（阿里云/腾讯云/AWS等）

这样可以更准确地定位问题！🎯

